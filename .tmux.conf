set-option -g prefix C-a
bind C-a send-prefix # work with nested sessions

set-option -g mouse on

# Select text using keyboard on copy mode
unbind-key -T copy-mode-vi v
unbind-key -T copy-mode-vi 'C-v'
bind-key -T copy-mode-vi v send -X begin-selection
bind-key -T copy-mode-vi 'C-v' send -X begin-selection \; send-keys -X rectangle-toggle
bind-key -T copy-mode-vi y send -X copy-selection-no-clear

# Exit from copy-mode with "a" (matching nvim terminal's normal mode)
bind-key -T copy-mode-vi a send -X cancel

# vim-like motions for selecting text:
# source1: https://old.reddit.com/r/vim/comments/12eg832/is_there_a_way_to_have_vim_objects_in_tmux/jfd1m40/
# source2: https://github.com/kite12580/.vim/blob/8669005063b5daead6a3101e90ecfb1160d1594a/config/.tmux.conf#L140-L156
bind-key -T copy-mode-vi i switch-client -T copyModeMultiKey_i
bind-key -T copyModeMultiKey_i w send-keys -X select-word
bind-key -T copyModeMultiKey_i W send-keys -X clear-selection \; send-keys -X previous-space \; send-keys -X begin-selection \; send-keys -X next-space-end
bind-key -T copyModeMultiKey_i b send-keys -X clear-selection \; send-keys -X jump-to-backward '(' \; send-keys -X begin-selection \; send-keys -X jump-to-forward ')'
bind-key -T copyModeMultiKey_i ( send-keys -X clear-selection \; send-keys -X jump-to-backward '(' \; send-keys -X begin-selection \; send-keys -X jump-to-forward ')'
bind-key -T copyModeMultiKey_i ) send-keys -X clear-selection \; send-keys -X jump-to-backward '(' \; send-keys -X begin-selection \; send-keys -X jump-to-forward ')'
bind-key -T copyModeMultiKey_i B send-keys -X clear-selection \; send-keys -X jump-to-backward '{' \; send-keys -X begin-selection \; send-keys -X jump-to-forward '}'
bind-key -T copyModeMultiKey_i \{ send-keys -X clear-selection \; send-keys -X jump-to-backward '{' \; send-keys -X begin-selection \; send-keys -X jump-to-forward '}'
bind-key -T copyModeMultiKey_i \} send-keys -X clear-selection \; send-keys -X jump-to-backward '{' \; send-keys -X begin-selection \; send-keys -X jump-to-forward '}'
bind-key -T copyModeMultiKey_i [ send-keys -X clear-selection \; send-keys -X jump-to-backward '[' \; send-keys -X begin-selection \; send-keys -X jump-to-forward ']'
bind-key -T copyModeMultiKey_i ] send-keys -X clear-selection \; send-keys -X jump-to-backward '[' \; send-keys -X begin-selection \; send-keys -X jump-to-forward ']'
bind-key -T copyModeMultiKey_i < send-keys -X clear-selection \; send-keys -X jump-to-backward '<' \; send-keys -X begin-selection \; send-keys -X jump-to-forward '>'
bind-key -T copyModeMultiKey_i > send-keys -X clear-selection \; send-keys -X jump-to-backward '<' \; send-keys -X begin-selection \; send-keys -X jump-to-forward '>'
bind-key -T copyModeMultiKey_i ` send-keys -X clear-selection \; send-keys -X jump-to-backward '`' \; send-keys -X begin-selection \; send-keys -X jump-to-forward '`'
bind-key -T copyModeMultiKey_i \' send-keys -X clear-selection \; send-keys -X jump-to-backward "'" \; send-keys -X begin-selection \; send-keys -X jump-to-forward "'"
bind-key -T copyModeMultiKey_i \" send-keys -X clear-selection \; send-keys -X jump-to-backward '"' \; send-keys -X begin-selection \; send-keys -X jump-to-forward '"'
bind-key -T copyModeMultiKey_i l send-keys -X clear-selection \; send-keys -X back-to-indentation \; send-keys -X begin-selection \; send-keys -X end-of-line \; send-keys -X cursor-left \; send-keys -X other-end

# Jump to last pane with prefix-\
bind "\\" last-pane
bind "C-\\" last-pane

# Copy mode colors
set-option -g mode-style bg=green,fg=black,blink

# vi bindings to switch panes
bind h select-pane -L
bind C-h select-pane -L
bind j select-pane -D
bind C-j select-pane -D
bind k select-pane -U
bind C-k select-pane -U
bind l select-pane -R
bind C-l select-pane -R

bind-key / copy-mode \; send ?

set-option -g @open_command 'xdg-open' # default for linux; override for macos happens on tmux-osx.conf

# NOTE: interpolating variables don't work here... So the regexes may be intentionally duplicated.
# Somewhat like tmux-open functionality
bind-key -T copy-mode-vi o send-keys -X copy-pipe-and-cancel "sed s/##/####/g | xargs -I{} tmux run-shell -b '#{@open_command} \"{}\" > /dev/null'"
bind-key -T copy-mode o send-keys -X copy-pipe-and-cancel "sed s/##/####/g | xargs -I{} tmux run-shell -b '#{@open_command} \"{}\" > /dev/null'"
# Open a popup to select a link from the visible pane content
bind-key U capture-pane -J \; display-popup -E "tmux show-buffer | \
  grep -oE '(https?://|git@|git://|ssh://|ftp://|file:///)[[:alpha:]+][[:alnum:]?=%/_.:,;~@!#$&*+-]*' | \
  awk '!x[$0]++' | \
  fzf --tac --prompt 'Url to open> ' | \
  sed s/##/####/g | \
  xargs -I{} tmux run-shell -b '#{@open_command} \"{}\"'"

# Somewhat tmux-copycat functionality
bind-key C-u copy-mode \; send -X search-backward '(https?://|git@|git://|ssh://|ftp://|file:///)[[:alpha:]+][[:alnum:]?=%/_.:,;~@!#$&*+-]*'
bind-key C-f copy-mode \; send -X search-backward '(^|^\.|[[:space:]]|[[:space:]]\.|[[:space:]]\.\.|^\.\.)[[:alnum:]~_-]*/[][[:alnum:]_.#$%&+=/@-]*'

## AESTHETICS
# Visual feedback on window activity
set-option -g monitor-activity on
set-option -g visual-activity on

# Theme
# based on https://github.com/dracula/tmux/blob/master/scripts/dracula.sh
set-option -g @white '#f8f8f2'
set-option -g @gray '#44475a'
set-option -g @dark_gray '#282a36'
set-option -g @light_purple '#bd93f9'
set-option -g @dark_purple '#6272a4'
set-option -g @cyan '#8be9fd'
set-option -g @green '#50fa7b'
set-option -g @orange '#ffb86c'
set-option -g @red '#ff5555'
set-option -g @pink '#ff79c6'
set-option -g @yellow '#f1fa8c'
set-option -g @left_icon "☺"
set-option -g @black '#21222c'
flags="#{?window_flags,#[fg=#{@white}]#{window_flags},} "
current_flags="#{?window_flags,#[fg=#{@light_purple}]#{s/\\*//:window_flags},}"
set-option -g pane-active-border-style "fg=#{@light_purple}"
set-option -g pane-border-style "fg=#{@gray}"
set-option -g message-style "bg=#{@gray},fg=#{@white}"
set-option -g status-style "bg=#{@gray},fg=#{@white}"
set-option -g status-left "#[bg=#{@green},fg=#{@dark_gray}]#{?client_prefix,#[bg=#{@yellow}],} #{@left_icon} "

set-option -g window-style "bg=#{@black},fg=#aeb0b1,dim"
set-option -g window-active-style "bg=terminal,fg=#{@white}"

set-option -g window-status-current-format "#[fg=#{@white},bg=#{@dark_purple}] ➤#I #W${current_flags} "
set-option -g window-status-format "#[fg=#{@white}]#[bg=#{@gray}] #I #W${flags}"

# History scroll size
set-option -g history-limit 50000

# status bar:
set-option -g status-right-length 100
set-option -g status-interval 60
set-option -g status-right '#($HOME/.tmux/scripts/status-bar `tmux display -p "#{client_width}"`) %R [#H]'

set-option -ga update-environment EDITOR

set-option -g @plugin 'tmux-plugins/tpm'
set-option -g @plugin 'tmux-plugins/tmux-sensible'

# This is important so we don't conflict the U binding (for opening links)
set-option -g @tpm-update 'C-U'

# NOTE: this must come AFTER the tmux-sensible plugin!
set-option -ga terminal-features ',alacritty*:hyperlinks' # clickable links (with SHIFT pressed)

# Import macos specific
if-shell 'test "$(uname -s)" = Darwin' 'source-file ~/.tmux-osx.conf'

# Install tpm and plugins if not yet installed
if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins'"

# Initialize TMUX plugin manager (should be at bottom)
run -b '~/.tmux/plugins/tpm/tpm'
